@page "/UserLogin"
@layout LoginLayout
@inject HttpClient Http
@using System.Net.Http.Json;
@using System.Text.Json
@using System.Threading
@inject Blazored.LocalStorage.ILocalStorageService localStore
@inject NavigationManager nav


<LoginForm OnValidSubmit="PostRequestLogin" LoginModel="usrLogin" />


@if (loadingbit == 2) {
    <FaderCount>
        <Alerts  Htmlstring=@errorMesssage  AlertType ="danger" />
    </FaderCount>
}else if (loadingbit == 1){
    <FaderCount>
    <LoadingModal/>
    </FaderCount>
}

@code{

    private LoginData usrLogin = new LoginData();
    string errorMesssage ="";
    int loadingbit = 0;

    private async Task PostRequestLogin()
    {
        
        loadingbit =1;
        var newLoging =  new LoginData {

            Email = usrLogin.Email,
            Password = usrLogin.Password

        };
        //var BaseAddress = Http.BaseAddress;
        var Uri =  "api/UserAccount/Login";
        var response = await Http.PostAsJsonAsync(Uri,newLoging);
        var result = await response.Content.ReadFromJsonAsync<UserToken>();
        Thread.Sleep(10000);
        var token = result.token;
            if (token != null){
                //Session on brower local storage
                await localStore.SetItemAsync("token", token);
                nav.NavigateTo("/Index");
            } else  {
                loadingbit =2;
                errorMesssage = $"Error : Bad Login";
            } 
    }

}

